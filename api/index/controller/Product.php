<?php/** * Created by 赵晓凡 * User: zhaoxiaofan * Date: 2017/2/17 * Time: 9:30 */namespace api\index\controller;use think\Db;use think\Request;use think\Session;use think\Image;/** * Class Index * @package home\index\controller * @return 首页页面 */class Product extends Auth{    /**     * 收藏接口     * @param userId  收藏人     * @param collectType  收藏类型 1 商品  2商家     * @param collectId  收藏商品的id 或 商家的id     * @param addDate  添加时间     * @return mixed    添加信息     */    public function collect()    {        if ($this->loginStatus)        {            $userId = $this->username;            $addDate = date('Y-m-d H:i:s', time());            $collectId = $this->request->param('collectId');            $collectType = $this->request->param('collectType');            $where['collectId'] = $collectId;            $where['userId'] = $userId;            $result = Db::name('collectrecords')->where($where)->find();            if (!empty($result))            {                $returnData['status'] = 2;                $returnData['msg'] = '已添加收藏';                return json($returnData);            }else {                $data['userId'] = $userId;                $data['addDate'] = $addDate;                $data['collectId'] = $collectId;                $data['collectType'] = $collectType;                $insertid = Db::name('collectrecords')->insertGetId($data);                if ($insertid)                {                    $returnData['data'] = array();                    $returnData['status'] =1;                    $returnData['msg'] ="添加成功";                }else{                    $returnData['data'] = array();                    $returnData['status'] =2;                    $returnData['msg'] ="添加失败";                }            }        }else {            $returnData['data'] = array();            $returnData['status'] = 0;            $returnData['msg'] = '未登录';        }        return json($returnData);    }    /**     * 商品收藏列表接口     * 请求方式：http://www.XXX.com/index/product/collect_list     * 请求方式：get     * 请求参数：     * @return \think\response\Json     */    public function collect_list()    {        if ($this->loginStatus)        {            $collectType=$this->request->param('collectType');            $userId = $this->username;            $pagecount=6;            $where['collectType'] = empty($collectType)?1:$collectType;            $where['userId'] = $userId;//            var_dump($where);exit;            $data = Db::name('collectrecords')->where($where)->field('collectId')->paginate($pagecount);            $dataArr=[];            foreach ($data as $k=>$v){                $fields='proid,proname,supplierid,marketprice,vipprice,consumeintegral,proimg,qiqiuproimgpath';                $map['proid'] = $v['collectId'];                $proinfo=Db::name('product')->where($map)->field($fields)->find();                if($proinfo){//                $proinfo['proimg']=config('IMAGE_DOMAIN_NAME').'/Upload/cpimg/'.$proinfo['proimg'];                    $proinfo['proimg']=$proinfo['proimg'];                    $proinfo['consumeintegral']=intval($proinfo['consumeintegral']);                    if(is_onqiniu()==true){                        $proinfo['img']=$proinfo['qiqiuproimgpath'];                    }else{                        if(strpos($proinfo['proimg'],'http://')!==false){                            $proinfo['img']=$proinfo['proimg'];                        }else{                            $proinfo['img']=config('IMAGE_DOMAIN_NAME').'/Upload/cpimg/'.$proinfo['proimg'];                        }//                        $proinfo['img']=config('IMAGE_DOMAIN_NAME').'/Upload/cpimg/'.$proinfo['proimg'];//图片地址//                        $proinfo['img']=$proinfo['proimg'];//图片地址                    }                    $dataArr[]=$proinfo;                }            }            if(!empty($dataArr)) {//                $returnData['total']=ceil($data->total()/$pagecount);//总页数//                $returnData['data'] = $dataArr;                $returnData["data"]['total']=ceil($data->total()/$pagecount);//总页数                $returnData["data"]['data_list'] = $dataArr;                $returnData['status'] = 1;                $returnData['msg'] = '获取列表数据成功';            }else{                $returnData['data'] = '';                $returnData['status'] = 0;                $returnData['msg'] = '暂无数据';            }        }        else        {            $returnData['status'] = 0;            $returnData['msg'] = '未登录';        }        return json($returnData);    }    /**     * 移出收藏列表接口     * 请求方式：http://www.XXX.com/index/product/collect_list     * 请求方式：get     * 请求参数：     * @return \think\response\Json     */    public function delCollect()    {        $userId = $this->username;        $collectId = $this->request->param('collectId');        $where['userId'] = $userId;        $where['collectId'] = $collectId;        $result = Db::name('collectrecords')->where($where)->delete();        if ($result)        {            $returnData["data"] = array();            $returnData['status'] = 1;            $returnData['msg'] = '删除收藏成功';        }else        {            $returnData["data"] = array();            $returnData['status'] = 0;            $returnData['msg'] = '暂无数据';        }        return json($returnData);    }    /**     * 商品详情接口     * 请求方式：http://www.XXX.com/goods/detail?proid=7671     * 请求方式：get     * 请求参数：     * @param   proid 产品id     * @return \think\response\Json     * $returnData['status'] :0=success;-1=fail     */    public function product_detail(){        $proid=$this->request->param('proid');        if(!empty($proid)&&is_numeric($proid)){            $where['ProId']=$proid;            $where['IsOnSell']=1;            $fields='supplierid,proid,maxproimg,qiqiupromaximgpath,qiqiuproimgpath,proimg,prosum,enjoyprice,marketprice,proname,marketprice,vipprice,consumeintegral,giveintegral,minpurchase,peisong,title,keywords,unit,productsizedetail,description,procontent,hit,orderstep';            $data=Db::name('product')->where($where)->field($fields)->find();            if($data) {                if(Session::get('username')){                    $condition['Agentd'] = Session::get('username');                    $data['cartnum']=Db::name('shoppingcart')->where($condition)->count();                }else{                    $data['cartnum']=0;                }                if(is_onqiniu()==true){                    $data['img']=$data['qiqiuproimgpath'];                    $data['maximg']=$data['qiqiupromaximgpath'];                }else{                    if(strpos($data['proimg'],'http://')!==false){                        $data['img']=$data['proimg'];                        $data['maximg']=$data['maxproimg'];                    }else{                        $data['img']=config('IMAGE_DOMAIN_NAME').'/Upload/cpimg/'.$data['proimg'];                        $data['maximg']=config('IMAGE_DOMAIN_NAME').'/Upload/cpimg/'.$data['maxproimg'];                    }//                    $data['img']=$data['proimg'];//图片地址//                    $data['img']=config('IMAGE_DOMAIN_NAME').'/Upload/cpimg/'.$data['proimg'];//图片地址////                    $data['maximg']=config('IMAGE_DOMAIN_NAME').'/Upload/cpimg/'.$data['maxproimg'];//                    $data['maximg']=$data['maxproimg'];                }                $data['pronum']=Db::name('product')->where('SupplierId="'.$data['supplierid'].' and IsOnSell=1"')->count();//获取商家的所有商品                $data['collectrecords']=Db::name('collectrecords')->where('collectType=2 and collectId="'.$data['supplierid'].'"')->count();//获取所有收藏商家的数量                $data['consumeintegral']=intval($data['consumeintegral']);                $data['giveintegral']=intval($data['giveintegral']);                $supinfo=$cpname=Db::name('supplier')->where("id=".$data['supplierid'])->field('name')->find();                $data['suppliername']=$supinfo['name'];//                $data['proimg']=config('IMAGE_DOMAIN_NAME').'/Upload/cpimg/'.$data['proimg'];                $data['proimg']=$data['proimg'];               $stylenameArr=Db::name('productstock')->where('ProId='.$data['proid'])->field('stylename1')->group('stylename1')->select();                foreach ($stylenameArr as $k=>$v){                    if($k==0){                        $selectname=$v['stylename1'];                    }                }                $wherestyleArr['ProId']=$data['proid'];                $wherestyleArr['stylename1']=$selectname;                $styleArr=Db::name('productstock')->where($wherestyleArr)->field('stylename,styleid')->select();                $this->product_hit($proid);//累加点击数                setcookie("BrowserHistory", "", time() - 3600);                $historyData="{$data['proid']}|{$data['proname']}|{$data['marketprice']}|{$data['vipprice']}|{$data['consumeintegral']}|{$data['proimg']}";                $this->product_history($historyData);//添加浏览记录到COOKIE                //详情页图片轮播                $albums=Db::name('productimg')->where('proid='.$data['proid'])->field('imgpath,qiniuimgpath')->select();                foreach ($albums as $key=>$val){                    if(is_onqiniu()==true){                        $albums[0]=$data['img'];//图片主图                        $albums[$key+1]=$val['qiniuimgpath'];//相册合集                    }else{                        $albums[0]=$data['proimg'];//图片主图                        if(strpos($val['imgpath'],'http://')!==false){                            $albums[$key+1]=$val['imgpath'];//相册合集                        }else{                            $albums[$key+1]=config('IMAGE_DOMAIN_NAME').'/Upload/prophoto/'.$val['imgpath'];//相册合集                        }//                        $albums[$key+1]=$val['imgpath'];//相册合集//                        $albums[$key+1]=config('IMAGE_DOMAIN_NAME').'/Upload/prophoto/'.$val['imgpath'];//相册合集                    }                }                if(is_onqiniu()==true){                    $data['procontent']=contentReplace($data['procontent']);                }else{                    if(strpos($data['proimg'],'http://')!==false){                        $str = '<img src="';                        $data['procontent'] = str_replace('<img src="',$str ,$data['procontent']);                    }else{                        $str = '<img src="'.config('IMAGE_DOMAIN_NAME').'';                        $data['procontent'] = str_replace('<img src="',$str ,$data['procontent']);                    }//                    $str = '<img src="'.config('IMAGE_DOMAIN_NAME').'';                }//var_dump($albums);exit;                $productvideo=Db::name('productvideo')->where('proid="'.$proid.'"')->find();                if($productvideo){                    $video=1;                }else{                    $video=2;                }                $wherekucun['ProId']=$data['proid'];                $kucun=Db::name('productstock')->where($wherekucun)->sum('Kucun');                $returnData['data']['isvideo']=$video;//是否显示视频                $returnData['data']['productvideo']=$productvideo;//详情页视频                $returnData['data']['imgalbum']=$albums;//详情页图片合集轮播                $returnData['data']['goodsstyle']=$styleArr;//规格                $returnData['data']['goodsstyle1']=$stylenameArr;//颜色                $returnData['data']['kucun']=$kucun;//库存                $returnData['data']['selectname']=$selectname;//默认选中名称                $returnData['data']['datails'] = $data;//数据详情                $returnData['status'] = 1;                $returnData['msg'] = '获取数据成功';            }else{                $returnData['data'] = '';                $returnData['status'] = 0;                $returnData['msg'] = '产品不存在或者已下架';            }        }else{            $returnData=['data'=>'','status'=>0,'mes'=>'参数格式错误，必须为非空数字'];        }        return json($returnData);    }    /**     * 商品列表接口     * 请求方式：http://www.XXX.com/goods/list?ishit=2     * 请求方式：get     * 请求参数：     * @param   ishit 产品展示区域id     * @return \think\response\Json     */    public function product_list(){        $pagesize=$this->request->param('pagesize');        $pagecount=!empty($pagesize)?:12;        $where['IsOnSell']=1;        $where['IsHit']=1;        $fields='proid,proname,ishit,enjoyprice,supplierid,marketprice,qiqiuproimgpath,vipprice,consumeintegral,proimg';        $data=Db::name('product')->where($where)->field($fields)->order('proid asc')->paginate($pagecount);        $dataArr=[];        foreach ($data as $key=>$val){            $supinfo=Db::table('supplier')->where("id=".$val['supplierid'])->field('name')->find();            $val['suppliername']=$supinfo['name'];            if(is_onqiniu()==true){                $val['img']=$val['qiqiuproimgpath'];            }else{                if(strpos($val['proimg'],'http://')!==false){                    $val['img']=$val['proimg'];                    $val['proimg']=$val['proimg'];                }else{                    $val['img']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];                    $val['proimg']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];                }//                    $val['img']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];//                $val['img']=$val['proimg'];            }//            $val['proimg']=$val['proimg'];//				$val['proimg']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];            $val['consumeintegral']=intval($val['consumeintegral']);            $dataArr[]=$val;        }        if(!empty($dataArr)) {//                $returnData['total']=ceil($data->total()/$pagecount);//总页数//                $returnData['data'] = $dataArr;            $returnData["data"]['total']=ceil($data->total()/$pagecount);//总页数            $returnData['data']["data_list"] = $dataArr;            $returnData['status'] = 1;            $returnData['msg'] = '获取列表数据成功';        }else{            $returnData['data'] = '';            $returnData['status'] = 0;            $returnData['msg'] = '暂无数据';        }        return json($returnData);    }    /**     * 设置cookie     */    private function product_history($data){        if(!empty($data)){            if (!empty($_COOKIE['BrowserHistory'])){                $history = explode(',', $_COOKIE['BrowserHistory']);                array_unshift($history, $data);//在这个数组的开头插入当前正在浏览的商品ID                $history = array_unique($history);//去除数组里重复的值                while (count($history) > 6){                    //将数组最后一个单元弹出，直到它的长度小于等于5为止                    array_pop($history);                }                //把这个数组用逗号连成一个字符串写入COOKIE，并设置其过期时间为30天                setcookie('BrowserHistory', implode(',', $history), time() + 3600 * 24 * 30);            }else{                //如果COOKIE里面为空，则把当前浏览的商品ID写入COOKIE ，这个只在第一次浏览该网站时发生                setcookie('BrowserHistory', $data, time() + 3600 * 24 * 30);            }        }    }    /**     * 获取cookie中存储的商品信息     * @return \think\response\Json     */    public function getHistory(){        $history =isset ($_COOKIE['BrowserHistory']) ? $_COOKIE['BrowserHistory'] : 0;        $arr=explode(',', $history);        $dataArr=[];        if(!empty($arr)){            foreach ($arr as $k=>$v){                $tempArr=explode('|',$v);                $datarr['proid']=$tempArr[0];                $datarr['proname']=$tempArr[1];                $datarr['marketprice']=$tempArr[2];                $datarr['vipprice']=$tempArr[3];                $datarr['consumeintegral']=$tempArr[4];                $datarr['proimg']=$tempArr[5];                $dataArr[]=$datarr;            }            $returnData['data'] = $dataArr;            $returnData['status'] = 1;            $returnData['msg'] = '获取列表数据成功';        }else{            $returnData['data'] = '';            $returnData['status'] = 0;            $returnData['msg'] = '暂无数据';        }        return json($returnData);    }    /**     * 产品库存接口     * 请求方式：http://www.XXX.com/goods/stock?proid=7671&styleid=9808     * 请求方式：get     * 请求参数：     * @param proid 商品id     * @param styleid   规格id     * @return \think\response\Json 库存数量     */    public function product_stock(){        $where['ProId']=$this->request->param('proid');        $where['StyleId']=$this->request->param('styleid');        $result=Db::name('productstock')->where($where)->field('Txm as txm,Kucun as kucun')->find();        if($result){            if(is_null($result['kucun'])){                $result['kucun']=0;            }            $returnData=$result;        }else{            $returnData=[];        }        return json($returnData);    }    public function product_stylename1(){        $where['ProId']=$this->request->param('proid');        $where['stylename1']=$this->request->param('stylename1');        $result=Db::name('productstock')->where($where)->field('StyleName as stylename,StyleId as styleid')->select();        if($result){            $returnData=$result;        }else{            $returnData=[];        }        return json($returnData);    }    /**     * 产品浏览量接口     * 请求方式：http://www.XXX.com/goods/hit?proid=7671     * 请求方式：get     * 请求参数：     * @param proid 产品id     * @return \think\response\Json 浏览量     */    public function product_hit($proid){        $where['ProId']=$proid;        $sql='update product set hit=hit+1 where ProId='.$proid;        Db::execute($sql);    }    /**     * 商品分类接口     * 请求方式：http://www.XXX.com/goods/category     * 请求方式：get     * 请求参数：无     * @return \think\response\Json     */    public function product_category(){        $cid=$this->request->param('cid');        if(empty($cid)){            $cid=0;        }        $model=Db::name('productcategory');        $where['pid']=0;        $where['disable']=1;        $layArr=$model->where($where)->field('Id as cid,name')->order('sort asc,Id  asc')->select();//为方便测试，添加双引号        foreach ($layArr as $key => $val){            $layArr[$key]["cid"] = (string)$val["cid"];        }        if ($layArr) {            $returnArr['data'] = $layArr;            $returnArr['status'] = 1;            $returnArr['msg'] = '数据记录';        } else {            $returnArr['category'] = '';            $returnArr['status'] = 0;            $returnArr['msg'] = '暂无数据';        }        if(!empty($layArr)){            foreach ($layArr as $key => $val){                $condition['pid'] = $val["cid"];                $condition['disable'] = 1;                $sub = $model->where($condition)->field('Id as sid,name,photo')->order('sort asc,Id asc')->limit(0,12)->select();                if(empty($sub)){                    $condition1['Id'] = $val["cid"];                    $condition1['disable'] = 1;                    $sub = $model->where($condition1)->field('Id as sid,name,photo')->select();                    foreach ($sub as $keys=>$vals){                        $sub[$keys]['img']=$sub[$keys]['photo'];                        $sub[$keys]['url']='/mobile.php/search_list?cid='.$vals['sid'].'&sort=1';                    }                }else{                    foreach ($sub as $key2=>$val2){//                    $sub[$key2]['img']=config('IMAGE_DOMAIN_NAME').$sub[$key2]['photo'];                        if(empty($sub[$key2]['photo'])){                            $sub[$key2]['img']='/Public/mobile/img/logo.png';                        }else{                            $sub[$key2]['img']=$sub[$key2]['photo'];                        }//           为方便测试，添加双引号                        $sub[$key2]["sid"] =(string)$sub[$key2]["sid"];                        $sub[$key2]["url"] ='/mobile.php/search_list?sid='.$sub[$key2]["sid"].'&sort=1';                    }                }                $returnArr['data'][$key]["child"]=$sub;            }//            if($cid==0){//                $condition['pid'] = ['>','0'];//            }else{//                $condition['pid'] = $cid;//            }//            $condition['disable'] = 1;//            $sub = $model->where($condition)->field('Id as sid,name')->order('Id asc')->limit(0,12)->select();//            foreach ($sub as $key=>$val){//                $sub[$key]['img']=config('IMAGE_DOMAIN_NAME').'/Public/mobile/images/toubu.jpg';//            }//            $returnArr['data']['main']=$sub;        }//        var_dump($returnArr);exit();        return json($returnArr);    }    /**     * 商品推荐的实现     */    public function product_categoryson()    {    }    /**     * 商品搜索接口     * 请求方式：http://www.XXX.com/goods/search     * 请求方式：get     * 请求参数：     * @param cid   一级分类id     * @param sid  二级分类id     * @param keyword   产品关键字     * @return \think\response\Json     */    public function product_search(){        $pagesize=$this->request->param('pagesize');        $pagecount=!empty($pagesize)?:6;        $where['IsOnSell']=1;        $where['IsHit']=1;        $where["MinPurchase"]=['>',0];        //产品一级分类查询条件        if($this->request->param('cid')){            if($this->request->param('cid')==999000){                $where['categoryId']=['in','2304,2311'];            }else{                $where['categoryId']=$this->request->param('cid');            }        }        //产品二级分类的查询条件        if($this->request->param('sid')){            $where['CategoryCode']=$this->request->param('sid');        }        //产品搜索的查询条件        if($this->request->param('keyword')){            $where['ProName']=['like','%'.$this->request->param("keyword").'%'];        }        //商家搜索的查询条件        if($this->request->param('supid')){            $where['SupplierId']=$this->request->param('supid');        }        if($this->request->param('ishit')&&$this->request->param('range')){            $ishit=$this->request->param('ishit');            $where['IsHit']=$ishit;            if($ishit==1){                $index='VipPrice';            }elseif($ishit==2){                $index='ConsumeIntegral';            }            $range=$this->request->param('range');            switch ($range){                case 2:                    $where[$index]=[['egt',0],['elt',1000],'and'];                    break;                case 3:                    $where[$index]=[['gt',1000],['elt',2000],'and'];                    break;                case 4:                    $where[$index]=[['gt',2000],['elt',3000],'and'];                    break;                case 5:                    $where[$index]=[['gt',4000],['elt',4000],'and'];                    break;                case 6:                    $where[$index]=['gt',4000];                    break;            }        }        $fields='proid,proname,ishit,supplierid,marketprice,enjoyprice,vipprice,consumeintegral,proimg,qiqiuproimgpath,prosum';        $issort=1;        $type='';        if($this->request->param('sort')){            $sort=$this->request->param('sort');            if($sort==1){                $data=Db::name('product')->where($where)->field($fields)->order('prosum desc')->paginate($pagecount);            }else{                $type=$this->request->param('type');                if($type){                    if($type==1){                        $issort=2;                        $type=2;                        $data=Db::name('product')->where($where)->field($fields)->order('vipprice asc')->paginate($pagecount);                    }else{                        $type=1;                        $data=Db::name('product')->where($where)->field($fields)->order('vipprice desc')->paginate($pagecount);                        $issort=3;                    }                }else{                    $issort=2;                    $type=2;                    $data=Db::name('product')->where($where)->field($fields)->order('vipprice asc')->paginate($pagecount);                }            }        }else{            $data=Db::name('product')->where($where)->field($fields)->order('proid asc')->paginate($pagecount);        }        $dataArr=[];        foreach ($data as $key=>$val){            $supinfo=Db::table('supplier')->where("id=".$val['supplierid'])->field('name')->find();            $val['suppliername']=$supinfo['name'];            $val['consumeintegral']=intval($val['consumeintegral']);            if(is_onqiniu()==true){                $val['img']=$val['qiqiuproimgpath'];            }else{                if(strpos($val['proimg'],'http://')!==false){                    $val['img']=$val['proimg'];                    $val['proimg']=$val['proimg'];                }else{                    $val['img']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];                    $val['proimg']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];                }//                $val['img']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];//图片地址//                $val['img']=$val['proimg'];//图片地址            }//            $val['proimg']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];//            $val['proimg']=$val['proimg'];            $dataArr[]=$val;        }        if(!empty($dataArr)) {//            $returnData['total']=ceil($data->total()/$pagecount);//总页数//            $returnData['data'] = $dataArr;            $returnData['data']['total']=ceil($data->total()/$pagecount);//总页数//var_dump($type);exit;            $returnData['data']['data_list'] = $dataArr;            $returnData['show'] = 1;            $returnData['issort'] = $issort;            $returnData['type'] = $type;            $returnData['status'] = 1;            $returnData['msg'] = '获取列表数据成功';        }else{            $returnData['data'] = '';            $returnData['status'] = 0;            $returnData['show'] = 0;            $returnData['issort'] = $issort;            $returnData['type'] = $type;            $returnData['msg'] = '暂无数据';        }        return json($returnData);    }    /**     * 尊享区商品     * 请求方式：http://www.XXX.com/goods/enjoylist     * 请求方式：get     * @return \think\response\Json     */    public function enjoylist(){        $pagesize=$this->request->param('pagesize');        $pagecount=!empty($pagesize)?:6;        $where['IsOnSell']=1;        $where['IsHit']=2;        $where["MinPurchase"]=['>',0];        //产品一级分类查询条件        $fields='proid,proname,ishit,supplierid,marketprice,enjoyprice,vipprice,consumeintegral,proimg,qiqiuproimgpath,prosum';        $issort=1;        $type='';        if($this->request->param('sort')){            $sort=$this->request->param('sort');            if($sort==1){                $data=Db::name('product')->where($where)->field($fields)->order('prosum desc')->paginate($pagecount);            }else{                $type=$this->request->param('type');                if($type){                    if($type==1){                        $issort=2;                        $type=2;                        $data=Db::name('product')->where($where)->field($fields)->order('vipprice asc')->paginate($pagecount);                    }else{                        $type=1;                        $data=Db::name('product')->where($where)->field($fields)->order('vipprice desc')->paginate($pagecount);                        $issort=3;                    }                }else{                    $issort=2;                    $type=2;                    $data=Db::name('product')->where($where)->field($fields)->order('vipprice asc')->paginate($pagecount);                }            }        }else{            $data=Db::name('product')->where($where)->field($fields)->order('proid asc')->paginate($pagecount);//            var_dump(Db::name('product')->getLastSql());exit;        }        $dataArr=[];        foreach ($data as $key=>$val){            $supinfo=Db::table('supplier')->where("id=".$val['supplierid'])->field('name')->find();            $val['suppliername']=$supinfo['name'];            $val['consumeintegral']=intval($val['consumeintegral']);            if(is_onqiniu()==true){                $val['img']=$val['qiqiuproimgpath'];            }else{                if(strpos($val['proimg'],'http://')!==false){                    $val['img']=$val['proimg'];                    $val['proimg']=$val['proimg'];                }else{                    $val['img']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];                    $val['proimg']=config('IMAGE_DOMAIN_NAME').'/public/Upload/cpimg/'.$val['proimg'];                }            }            $dataArr[]=$val;        }        if(!empty($dataArr)) {            $returnData['data']['total']=ceil($data->total()/$pagecount);//总页数            $returnData['data']['data_list'] = $dataArr;            $returnData['show'] = 1;            $returnData['issort'] = $issort;            $returnData['type'] = $type;            $returnData['status'] = 1;            $returnData['msg'] = '获取列表数据成功';        }else{            $returnData['status'] = 0;            $returnData['show'] = 0;            $returnData['issort'] = $issort;            $returnData['type'] = $type;            $returnData['msg'] = '暂无数据';        }        return json($returnData);    }}